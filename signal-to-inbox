#!/usr/bin/env node

/* Repo: https://github.com/jneidel/signal-cli-to-file */
const fs = require("fs/promises");
const fsSync = require("fs");
const path = require("path");
const { createProcessor } = require("./src/processor");

const configDir = process.env.XDG_CONFIG_HOME || path.join(process.env.HOME, ".config");
const configFile = path.join(configDir, "signal-to-inbox", "config.json");
let config = {};
try {
    const rawConfig = fsSync.readFileSync(configFile, "utf8");
    config = JSON.parse(rawConfig);
} catch (error) {
    if (error?.code !== "ENOENT") {
        console.error(`Failed to load config file: ${configFile}`);
        console.error(error.message);
        process.exit(1);
    }
}

const signalNumber = config.signalNumber ?? config.signal_number ?? "";

const inboxDir = config.inboxDir ?? config.inbox_dir ?? "";

const apiHost = config.apiHost ?? config.api_host ?? "";

const messageFileExtension = config.messageFileExtension ?? config.message_file_extension ?? "md";

const debugging = config.debugging ?? false;

const backupMessages = config.backupMessages ?? config.backup_messages ?? true;

const keepAllAttachments = config.keepAllAttachments ?? config.keep_all_attachments ?? false;

const senderAndGroupWhitelist = config.senderAndGroupWhitelist ?? config.sender_and_group_whitelist ?? [];

const filenameFromBodyCutoff = 60;
const filenameFromTitleCutoff = 80;

if (!signalNumber || !inboxDir || !apiHost) {
    if (!signalNumber) console.error("config: signalNumber is not set\n")
    if (!inboxDir) console.error("config: inboxDir is not set\n")
    if (!apiHost) console.error("config: apiHost is not set\n")
    
    console.error("The required configuration variables are not set.\n\nSee: https://github.com/jneidel/signal-to-inbox#configuration")
    process.exit(1);
}
fs.stat(inboxDir).catch(() => {
    console.error( `Configured inboxDir '${inboxDir}' does not exist` )
    process.exit(2);
})

const processor = createProcessor({
    inboxDir,
    apiHost,
    messageFileExtension,
    debugging,
    backupMessages,
    keepAllAttachments,
    senderAndGroupWhitelist,
    filenameFromBodyCutoff,
    filenameFromTitleCutoff
});
const { fetchApi, logError, processMessages } = processor;

fetchApi(`/v1/health`).catch(() => {
    console.error( `Configured apiHost '${apiHost}' is not reachable` )
    process.exit(3);
})

fetchApi(`/v1/receive/${signalNumber}?ignore_stories=true&send_read_receipts=true`)
    .then( r => r.json() )
    .then( messages => {
        if (debugging) console.log( "Results from /receive:\n" + JSON.stringify(messages, null, 2) )

        if ( messages?.error )
            logError(`Error on /receive:
${messages.error}`).then(() => process.exit(1))

        return processMessages(messages);
    })
    .then( summary => {
        if (!summary) return;
        const { createdFiles, appendedFiles, parsedCount, ignoredCount } = summary;

        if (debugging) {
            console.log(`Messages parsed : ${parsedCount}`);
            console.log(`Messages ignored: ${ignoredCount}`);
        }

        if (createdFiles.length) {
            console.log("New files created:");
            createdFiles.forEach(filename => console.log(`- ${filename}`));
        }
        if (appendedFiles.length) {
            if (createdFiles.length) console.log("");
            console.log("Existing files appended to:");
            appendedFiles.forEach(filename => console.log(`- ${filename}`));
        }

        if (!createdFiles.length && !appendedFiles.length) {
            console.log("No files were written.");
        }
    })
